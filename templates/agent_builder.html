{% extends "base.html" %}

{% block title %}Rainn | Builder{% endblock %}

{% block content %}

<!-- ======================================================
 Builder Header (Tabler Page Header)
 Shows page context and notes that this is retained for
 Iteration 3 demos while previewing Iteration 4 direction.
====================================================== -->
<div class="page-header d-print-none">
  <div class="row g-2 align-items-center">
    <div class="col">
      <div class="page-pretitle">Builder</div>
      <h2 class="page-title">Create an agent process</h2>
      <div class="text-secondary">Step-by-step builder for non-technical users.</div>
    </div>
  </div>
</div>

<div class="row row-cards">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="builder-steps">
          <div class="builder-step {% if step == 'details' %}active{% endif %}">
            <span class="builder-step-num">1</span>
            <span class="builder-step-label">Details</span>
          </div>
          <div class="builder-step {% if step == 'template' %}active{% endif %}">
            <span class="builder-step-num">2</span>
            <span class="builder-step-label">Choose Template</span>
          </div>
          <div class="builder-step {% if step == 'stages' %}active{% endif %}">
            <span class="builder-step-num">3</span>
            <span class="builder-step-label">Define Stages</span>
          </div>
          <div class="builder-step {% if step == 'review' %}active{% endif %}">
            <span class="builder-step-num">4</span>
            <span class="builder-step-label">Review</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======================================================
 Main Layout (Form + Stage Preview)
 Left: Agent builder form
 Right: Stage preview for selected operation/template
====================================================== -->
<div class="row row-cards">

  <!-- ======================================================
   Agent Builder Form Card
   Submits to same route using POST.
  ======================================================= -->
  <div class="col-12 {% if step == 'template' or step == 'details' %}col-lg-12{% else %}col-lg-8{% endif %}">
    <div class="card">
      <div class="card-body">

        <!-- Form submits to the same route using POST -->
        <form method="POST" class="row g-3" id="builderForm">

          {% if error_message %}
            <div class="col-12">
              <div class="alert alert-danger mb-0">{{ error_message }}</div>
            </div>
          {% endif %}

          {% if step == 'details' %}
          <div class="col-12">
            <div class="fw-semibold">Agent details</div>
            <div class="text-secondary small">These settings apply to every stage.</div>
          </div>
          <!-- ===============================
               Agent Name Input
          =============================== -->
          <div class="col-12">
            <label class="form-label">Agent name</label>
            <input type="text" class="form-control" name="agent_name" value="{{ agent_name or '' }}" required>
          </div>

          <!-- ===============================
               Agent Primer Input
               Captures role, tone, constraints, and output expectations.
          =============================== -->
          <div class="col-12">
            <label class="form-label">Agent primer</label>
            <textarea class="form-control" name="agent_priming" rows="3" required>{{ agent_priming or '' }}</textarea>
            <div class="form-hint">Describe the agent role, tone, constraints, and what “good output” looks like.</div>
          </div>

          <!-- ===============================
               AI Model Selection (Ollama)
               Uses exact Ollama model id (will change in future iterations to a simpler name selection).
          =============================== -->
          <div class="col-12 col-md-6">
            <label class="form-label">AI model (Ollama)</label>
            <select name="ai_model" class="form-select" required>
              <option value="">-- Choose Model --</option>
              <option value="gemma3:4b" {% if ai_model == "gemma3:4b" %}selected{% endif %}>gemma3:4b</option>
              <option value="llama3.1:8b" {% if ai_model == "llama3.1:8b" %}selected{% endif %}>llama3.1:8b</option>
            </select>
            <div class="form-hint">Use the exact Ollama model id.</div>
          </div>
          {% endif %}

          {% if step == 'template' %}
          <input type="hidden" name="agent_name" value="{{ agent_name or '' }}">
          <input type="hidden" name="agent_priming" value="{{ agent_priming or '' }}">
          <input type="hidden" name="ai_model" value="{{ ai_model or '' }}">
          <input type="hidden" name="action" id="templateAction" value="choose_template">
          <input type="hidden" name="operation_selected" id="templateId" value="">
          <input type="hidden" name="from_scratch" id="fromScratch" value="">

          <div class="col-12">
            <div class="fw-semibold mb-2">Choose a template</div>
            <div class="text-secondary mb-1">Pick a blueprint to start from, or build from scratch.</div>
            <div class="text-secondary small">Templates are starting points—you can edit stages next.</div>
          </div>

          <div class="col-12">
            <div class="row g-2">
              {% for t in template_taskdefs %}
              <div class="col-12 col-md-6">
                <div class="card card-sm template-card h-100"
                     role="button"
                     tabindex="0"
                     data-template-id="{{ t.TaskDef_ID }}">
                  <div class="card-body">
                    <div class="fw-semibold">{{ t.TaskDef_Name }}</div>
                    <div class="text-secondary small">{{ t.TaskDef_Description }}</div>
                  </div>
                </div>
              </div>
              {% endfor %}
              <div class="col-12 col-md-6">
                <div class="card card-sm template-card h-100"
                     role="button"
                     tabindex="0"
                     data-scratch="true">
                  <div class="card-body">
                    <div class="fw-semibold">Start from scratch</div>
                    <div class="text-secondary small">Create your own stages with a blank template.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 d-flex justify-content-between">
            <button type="button" class="btn btn-outline-secondary" onclick="goBackDetails()">
              <i class="ti ti-arrow-left me-2"></i>Back
            </button>
            <button type="button" class="btn btn-primary" id="templateNextBtn" onclick="goNextStages()" disabled>
              Next<i class="ti ti-arrow-right ms-2"></i>
            </button>
          </div>
          {% endif %}

          {% if step == 'stages' %}
          <input type="hidden" name="agent_name" value="{{ agent_name or '' }}">
          <input type="hidden" name="agent_priming" value="{{ agent_priming or '' }}">
          <input type="hidden" name="ai_model" value="{{ ai_model or '' }}">
          <input type="hidden" name="operation_selected" value="{{ selected_taskdef or '' }}">
          <input type="hidden" name="from_scratch" value="{% if from_scratch %}on{% endif %}">

          <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
              <h3 class="card-title mb-0">Stage instructions</h3>
              <button type="button" class="btn btn-outline-secondary" id="addStageBtn">
                <i class="ti ti-plus me-2"></i>Add stage
              </button>
            </div>
            <div class="text-secondary">Stage 0 is automatic. If no output stage is present, one will be added.</div>
            <div class="text-secondary small">Tip: use short verbs like “extract”, “validate”, “output”.</div>
          </div>

          <div class="col-12" id="stageContainer">
            {% if edit_stages %}
            {% for s in edit_stages %}
            <div class="row g-2 stage-row">
              <div class="col-12 col-md-3">
                <label class="form-label">Stage name</label>
                <input type="text" name="stage_name[]" class="form-control" required value="{{ s[0] }}" placeholder="e.g., extract, validate, output">
              </div>
              <div class="col-12 col-md-8">
                <label class="form-label">Stage instruction</label>
                <input type="text" name="stage_desc[]" class="form-control" required value="{{ s[1] }}" placeholder="Describe what this stage should do">
              </div>
              <div class="col-12 col-md-1 d-flex align-items-end gap-2 stage-actions">
                <div class="stage-move">
                  <button type="button" class="stage-move-btn move-up" title="Move up">
                    <i class="ti ti-chevron-up"></i>
                  </button>
                  <button type="button" class="stage-move-btn move-down" title="Move down">
                    <i class="ti ti-chevron-down"></i>
                  </button>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm btn-icon remove-stage">
                  <i class="ti ti-x"></i>
                </button>
              </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="row g-2 stage-row">
              <div class="col-12 col-md-3">
                <label class="form-label">Stage name</label>
                <input type="text" name="stage_name[]" class="form-control" required placeholder="e.g., extract, validate, output">
              </div>
              <div class="col-12 col-md-8">
                <label class="form-label">Stage instruction</label>
                <input type="text" name="stage_desc[]" class="form-control" required placeholder="Describe what this stage should do">
              </div>
              <div class="col-12 col-md-1 d-flex align-items-end gap-2 stage-actions">
                <div class="stage-move">
                  <button type="button" class="stage-move-btn move-up" title="Move up">
                    <i class="ti ti-chevron-up"></i>
                  </button>
                  <button type="button" class="stage-move-btn move-down" title="Move down">
                    <i class="ti ti-chevron-down"></i>
                  </button>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm btn-icon remove-stage">
                  <i class="ti ti-x"></i>
                </button>
              </div>
            </div>
            {% endif %}
          </div>
          {% endif %}

          {% if step == 'review' %}
          <input type="hidden" name="agent_name" value="{{ agent_name or '' }}">
          <input type="hidden" name="agent_priming" value="{{ agent_priming or '' }}">
          <input type="hidden" name="ai_model" value="{{ ai_model or '' }}">
          <input type="hidden" name="operation_selected" value="{{ selected_taskdef or '' }}">
          <input type="hidden" name="from_scratch" value="{% if from_scratch %}on{% endif %}">

          {% for s in edit_stages %}
            <input type="hidden" name="stage_name[]" value="{{ s[0] }}">
            <input type="hidden" name="stage_desc[]" value="{{ s[1] }}">
          {% endfor %}

          <div class="col-12">
            <div class="fw-semibold mb-2">Review</div>
            <div class="text-secondary">
              Agent: <strong>{{ agent_name }}</strong> • Model: <strong>{{ ai_model }}</strong>
            </div>
            <div class="text-secondary mb-3">
              {% if from_scratch %}
                Custom template from scratch
              {% elif selected_taskdef %}
                {% set selected = (taskdefs | selectattr("TaskDef_ID", "equalto", selected_taskdef) | list | first) %}
                Blueprint: {{ selected.TaskDef_Name if selected else selected_taskdef }}
              {% else %}
                No blueprint selected
              {% endif %}
            </div>

            <ol class="mb-0">
              {% for s in edit_stages %}
                <li class="mb-2">
                  <div class="fw-semibold">{{ s[0] }}</div>
                  <div class="text-secondary">{{ s[1] }}</div>
                </li>
              {% endfor %}
            </ol>
          </div>
          {% endif %}

          <!-- ===============================
               Submit Button
               Triggers saving the agent process definition.
          =============================== -->
          <div class="col-12">
            {% if step == 'details' %}
              <button type="submit" name="action" value="next" class="btn btn-primary">
                <i class="ti ti-arrow-right me-2"></i>Next
              </button>
            {% elif step == 'stages' %}
              <button type="submit" name="action" value="back_template" class="btn btn-outline-secondary me-2">
                <i class="ti ti-arrow-left me-2"></i>Back
              </button>
              <button type="submit" name="action" value="review" class="btn btn-primary">
                <i class="ti ti-arrow-right me-2"></i>Review
              </button>
            {% elif step == 'review' %}
              <button type="submit" name="action" value="back_stages" class="btn btn-outline-secondary me-2">
                <i class="ti ti-arrow-left me-2"></i>Back
              </button>
              <button type="submit" name="action" value="save" class="btn btn-primary">
                <i class="ti ti-device-floppy me-2"></i>Create agent
              </button>
            {% endif %}
          </div>

          <!-- ===============================
               Success Message
               Displayed only when agent process is created.
          =============================== -->
          {% if agent_saved %}
            <div class="col-12">
              <div class="alert alert-success mb-0">
                Agent process created successfully. <strong>Process ID:</strong> {{ saved_process_id }}
              </div>
            </div>
          {% endif %}

        </form>
      </div>
    </div>
  </div>

  <!-- ======================================================
   Stages Preview Panel
   Displays stages for the selected operation/template.
   If no stages are available, shows a hint message.
  ======================================================= -->
  {% if step != 'template' and step != 'details' %}
  <div class="col-12 col-lg-4">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Stages preview</h3>
      </div>
      <div class="card-body">
        <div class="text-secondary small mb-2">Live preview of your current stages.</div>
        <div id="stagePreview">
          {% if preview_stages %}
            <ol class="mb-0">
              {% for s in preview_stages %}
                <li class="mb-2">
                  <div class="fw-semibold">{{ s[0] }}</div>
                  <div class="text-secondary">{{ s[1] }}</div>
                </li>
              {% endfor %}
            </ol>
          {% elif step == 'stages' and from_scratch %}
            <div class="text-secondary">Starting from scratch. No stages yet.</div>
          {% else %}
            <div class="text-secondary">Stages will appear here once added.</div>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
  {% endif %}

</div>

{% if step == 'stages' %}
<script>
  (function () {
    const container = document.getElementById("stageContainer");
    const addBtn = document.getElementById("addStageBtn");
    const preview = document.getElementById("stagePreview");

    function updateRowButtons() {
      const rows = container.querySelectorAll(".stage-row");
      rows.forEach((row, idx) => {
        const removeBtn = row.querySelector(".remove-stage");
        const upBtn = row.querySelector(".move-up");
        const downBtn = row.querySelector(".move-down");

        removeBtn.onclick = () => {
          row.remove();
          updateRowButtons();
          renderPreview();
        };

        upBtn.disabled = idx === 0;
        downBtn.disabled = idx === rows.length - 1;

        upBtn.onclick = () => {
          const prev = row.previousElementSibling;
          if (prev) {
            container.insertBefore(row, prev);
            updateRowButtons();
            renderPreview();
          }
        };

        downBtn.onclick = () => {
          const next = row.nextElementSibling;
          if (next) {
            container.insertBefore(next, row);
            updateRowButtons();
            renderPreview();
          }
        };
      });
    }

    function renderPreview() {
      if (!preview) return;
      const rows = container.querySelectorAll(".stage-row");
      const stages = [];
      rows.forEach((row) => {
        const name = (row.querySelector('input[name="stage_name[]"]') || {}).value || "";
        const desc = (row.querySelector('input[name="stage_desc[]"]') || {}).value || "";
        if (name.trim() || desc.trim()) {
          stages.push({ name: name.trim(), desc: desc.trim() });
        }
      });

      if (!stages.length) {
        preview.innerHTML = '<div class="text-secondary">Stages will appear here once added.</div>';
        return;
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      const items = stages.map((s) => (
        `<li class="mb-2"><div class="fw-semibold">${escapeHtml(s.name || "[Unnamed Stage]")}</div>` +
        `<div class="text-secondary">${escapeHtml(s.desc || "")}</div></li>`
      )).join("");
      preview.innerHTML = `<ol class="mb-0">${items}</ol>`;
    }

    addBtn.addEventListener("click", () => {
      const row = container.querySelector(".stage-row").cloneNode(true);
      row.querySelectorAll("input").forEach((i) => (i.value = ""));
      container.appendChild(row);
      updateRowButtons();
      renderPreview();
    });

    updateRowButtons();
    container.addEventListener("input", renderPreview);
    renderPreview();
  })();
</script>
{% endif %}

{% if step == 'template' %}
<script>
  function selectTemplate(el) {
    const templateId = document.getElementById("templateId");
    const fromScratch = document.getElementById("fromScratch");
    const nextBtn = document.getElementById("templateNextBtn");
    const cards = document.querySelectorAll(".template-card");

    templateId.value = el.getAttribute("data-template-id") || "";
    fromScratch.value = el.getAttribute("data-scratch") ? "on" : "";

    cards.forEach((c) => c.classList.remove("selected"));
    el.classList.add("selected");

    if (nextBtn) nextBtn.disabled = !templateId.value && !fromScratch.value;
  }

  function goBackDetails() {
    const action = document.getElementById("templateAction");
    action.value = "back_details";
    document.getElementById("builderForm").submit();
  }

  function goNextStages() {
    const action = document.getElementById("templateAction");
    action.value = "choose_template";
    document.getElementById("builderForm").submit();
  }

  (function () {
    const cards = document.querySelectorAll(".template-card");
    const templateId = document.getElementById("templateId");
    const fromScratch = document.getElementById("fromScratch");
    const nextBtn = document.getElementById("templateNextBtn");
    cards.forEach((card) => {
      card.addEventListener("click", () => selectTemplate(card));
      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          selectTemplate(card);
        }
      });
    });

    if (templateId && templateId.value) {
      const match = document.querySelector(`.template-card[data-template-id="${templateId.value}"]`);
      if (match) match.classList.add("selected");
    }
    if (fromScratch && fromScratch.value) {
      const scratch = document.querySelector('.template-card[data-scratch="true"]');
      if (scratch) scratch.classList.add("selected");
    }
    if (nextBtn) {
      nextBtn.disabled = !templateId.value && !fromScratch.value;
    }
  })();
</script>
{% endif %}

{% endblock %}
