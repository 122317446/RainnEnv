{% extends "base.html" %}

{% block title %}Rainn | Builder{% endblock %}

{% block content %}

<!-- ======================================================
 Builder Header (Tabler Page Header)
 Shows page context and notes that this is retained for
 Iteration 3 demos while previewing Iteration 4 direction.
====================================================== -->
<div class="page-header d-print-none">
  <div class="row g-2 align-items-center">
    <div class="col">
      <div class="page-pretitle">Builder</div>
      <h2 class="page-title">Create an agent process</h2>
      <div class="text-secondary">Iteration 4 preview - current form is retained for Iteration 3 demos.</div>
    </div>
  </div>
</div>

<!-- ======================================================
 Main Layout (Form + Stage Preview)
 Left: Agent builder form
 Right: Stage preview for selected operation/template
====================================================== -->
<div class="row row-cards">

  <!-- ======================================================
   Agent Builder Form Card
   Submits to same route using POST.
  ======================================================= -->
  <div class="col-12 col-lg-8">
    <div class="card">
      <div class="card-body">

        <!-- Form submits to the same route using POST -->
        <form method="POST" class="row g-3" id="builderForm">

          {% if error_message %}
            <div class="col-12">
              <div class="alert alert-danger mb-0">{{ error_message }}</div>
            </div>
          {% endif %}

          <!-- ===============================
               Agent Name Input
          =============================== -->
          <div class="col-12">
            <label class="form-label">Agent name</label>
            <input type="text" class="form-control" name="agent_name" value="{{ agent_name or '' }}" required>
          </div>

          <!-- ===============================
               Agent Primer Input
               Captures role, tone, constraints, and output expectations.
          =============================== -->
          <div class="col-12">
            <label class="form-label">Agent primer</label>
            <textarea class="form-control" name="agent_priming" rows="3" required>{{ agent_priming or '' }}</textarea>
            <div class="form-hint">Describe the agent role, tone, constraints, and what “good output” looks like.</div>
          </div>

          <!-- ===============================
               AI Model Selection (Ollama)
               Uses exact Ollama model id (will change in future iterations to a simpler name selection).
          =============================== -->
          <div class="col-12 col-md-6">
            <label class="form-label">AI model (Ollama)</label>
            <select name="ai_model" class="form-select" required>
              <option value="">-- Choose Model --</option>
              <option value="gemma3:4b" {% if ai_model == "gemma3:4b" %}selected{% endif %}>gemma3:4b</option>
              <option value="llama3.1:8b" {% if ai_model == "llama3.1:8b" %}selected{% endif %}>llama3.1:8b</option>
            </select>
            <div class="form-hint">Use the exact Ollama model id.</div>
          </div>

          <!-- ===============================
               Operation / Template Selection
               Uses Jinja loop to display all taskdefs.
               selected_taskdef preserves user choice.
          =============================== -->
          <div class="col-12 col-md-6">
            <label class="form-label">Operation / template</label>
            <select name="operation_selected" class="form-select">
              <option value="">-- Choose Task --</option>
              {% for t in taskdefs %}
                <option value="{{ t.TaskDef_ID }}" {% if selected_taskdef == t.TaskDef_ID %} selected {% endif %}>
                  {{ t.TaskDef_Name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-12">
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="from_scratch" {% if from_scratch %}checked{% endif %}>
              <span class="form-check-label">Start from scratch (ignore blueprint template)</span>
            </label>
          </div>

          {% if edit_mode %}
          <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
              <h3 class="card-title mb-0">Stage instructions</h3>
              <button type="button" class="btn btn-outline-secondary" id="addStageBtn">
                <i class="ti ti-plus me-2"></i>Add stage
              </button>
            </div>
            <div class="text-secondary">Stage 0 is automatic. If no output stage is present, one will be added.</div>
          </div>

          <div class="col-12" id="stageContainer">
            {% if edit_stages %}
            {% for s in edit_stages %}
            <div class="row g-2 stage-row">
              <div class="col-12 col-md-4">
                <label class="form-label">Stage name</label>
                <input type="text" name="stage_name[]" class="form-control" required value="{{ s[0] }}">
              </div>
              <div class="col-12 col-md-7">
                <label class="form-label">Stage instruction</label>
                <input type="text" name="stage_desc[]" class="form-control" required value="{{ s[1] }}">
              </div>
              <div class="col-12 col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger w-100 remove-stage">
                  <i class="ti ti-x"></i>
                </button>
              </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="row g-2 stage-row">
              <div class="col-12 col-md-4">
                <label class="form-label">Stage name</label>
                <input type="text" name="stage_name[]" class="form-control" required>
              </div>
              <div class="col-12 col-md-7">
                <label class="form-label">Stage instruction</label>
                <input type="text" name="stage_desc[]" class="form-control" required>
              </div>
              <div class="col-12 col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger w-100 remove-stage">
                  <i class="ti ti-x"></i>
                </button>
              </div>
            </div>
            {% endif %}
          </div>
          {% endif %}

          <!-- ===============================
               Submit Button
               Triggers saving the agent process definition.
          =============================== -->
          <div class="col-12">
            {% if edit_mode %}
              <button type="submit" name="action" value="save" class="btn btn-primary">
                <i class="ti ti-device-floppy me-2"></i>Save agent process
              </button>
            {% else %}
              <button type="submit" name="action" value="next" class="btn btn-primary">
                <i class="ti ti-arrow-right me-2"></i>Next
              </button>
            {% endif %}
          </div>

          <!-- ===============================
               Success Message
               Displayed only when agent process is created.
          =============================== -->
          {% if agent_saved %}
            <div class="col-12">
              <div class="alert alert-success mb-0">
                Agent process created successfully. <strong>Process ID:</strong> {{ saved_process_id }}
              </div>
            </div>
          {% endif %}

        </form>
      </div>
    </div>
  </div>

  <!-- ======================================================
   Stages Preview Panel
   Displays stages for the selected operation/template.
   If no stages are available, shows a hint message.
  ======================================================= -->
  <div class="col-12 col-lg-4">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Stages preview</h3>
      </div>
      <div class="card-body">

        <!-- Stages only render after selecting an operation -->
        {% if from_scratch %}
          <div class="text-secondary">Starting from scratch. No blueprint stages selected.</div>
        {% elif stages %}
          <ol class="mb-0">
            {% for s in stages %}
              <li class="mb-2">
                <div class="fw-semibold">{{ s.TaskStageDef_Type }}</div>
                <div class="text-secondary">{{ s.TaskStageDef_Description }}</div>
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <div class="text-secondary">Select an operation to preview its stages.</div>
        {% endif %}

      </div>
    </div>
  </div>

</div>

{% if edit_mode %}
<script>
  (function () {
    const container = document.getElementById("stageContainer");
    const addBtn = document.getElementById("addStageBtn");

    function updateRemoveButtons() {
      const rows = container.querySelectorAll(".stage-row");
      rows.forEach((row) => {
        const btn = row.querySelector(".remove-stage");
        btn.onclick = () => {
          row.remove();
          updateRemoveButtons();
        };
      });
    }

    addBtn.addEventListener("click", () => {
      const row = container.querySelector(".stage-row").cloneNode(true);
      row.querySelectorAll("input").forEach((i) => (i.value = ""));
      container.appendChild(row);
      updateRemoveButtons();
    });

    updateRemoveButtons();
  })();
</script>
{% endif %}

<script>
  (function () {
    const fromScratch = document.querySelector('input[name="from_scratch"]');
    const templateSelect = document.querySelector('select[name="operation_selected"]');
    if (!fromScratch || !templateSelect) return;

    function toggleTemplateSelect() {
      templateSelect.disabled = fromScratch.checked;
    }

    fromScratch.addEventListener("change", toggleTemplateSelect);
    toggleTemplateSelect();
  })();
</script>

{% endblock %}
