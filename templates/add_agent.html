{% extends "base.html" %}

{% block title %}Rainn | Create Template{% endblock %}

{% block content %}

<div class="page-header d-print-none">
  <div class="row g-2 align-items-center">
    <div class="col">
      <div class="page-pretitle">Template Builder</div>
      <h2 class="page-title">Create an agent template</h2>
      <div class="text-secondary">Define stage-by-stage instructions in plain language.</div>
    </div>
  </div>
</div>

<div class="row row-cards">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <form method="POST" class="row g-3" id="stageForm">

          <div class="col-12">
            <label class="form-label">Template name</label>
            <input type="text" name="agent_name" class="form-control" required>
          </div>

          <div class="col-12">
            <label class="form-label">Template description</label>
            <textarea name="agent_description" class="form-control" rows="3"></textarea>
            <div class="form-hint">Explain what this template is for.</div>
          </div>

          <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
              <h3 class="card-title mb-0">Stages</h3>
              <button type="button" class="btn btn-outline-secondary" id="addStageBtn">
                <i class="ti ti-plus me-2"></i>Add stage
              </button>
            </div>
            <div class="text-secondary">Stage 0 (input normalisation) is automatic.</div>
          </div>

          <div class="col-12" id="stageContainer">
            <div class="row g-2 stage-row">
              <div class="col-12 col-md-4">
                <label class="form-label">Stage name</label>
                <input type="text" name="stage_name[]" class="form-control" required placeholder="e.g., extract, graph, output">
              </div>
              <div class="col-12 col-md-7">
                <label class="form-label">Stage instruction</label>
                <input type="text" name="stage_desc[]" class="form-control" required placeholder="Describe what this stage should do">
              </div>
              <div class="col-12 col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger w-100 remove-stage" disabled>
                  <i class="ti ti-x"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="col-12">
            <button type="submit" class="btn btn-primary">
              <i class="ti ti-device-floppy me-2"></i>Create template
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const container = document.getElementById("stageContainer");
    const addBtn = document.getElementById("addStageBtn");

    function updateRemoveButtons() {
      const rows = container.querySelectorAll(".stage-row");
      rows.forEach((row, idx) => {
        const btn = row.querySelector(".remove-stage");
        btn.disabled = rows.length === 1;
        btn.onclick = () => {
          row.remove();
          updateRemoveButtons();
        };
      });
    }

    addBtn.addEventListener("click", () => {
      const row = container.querySelector(".stage-row").cloneNode(true);
      row.querySelectorAll("input").forEach((i) => (i.value = ""));
      container.appendChild(row);
      updateRemoveButtons();
    });

    updateRemoveButtons();
  })();
</script>

{% endblock %}
